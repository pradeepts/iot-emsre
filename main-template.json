{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "iotEdgeAdminUserName":{
            "type": "string",
            "metadata": {
                "description":"username for windows virtual machine"
            }
        },
        "iotEdgeAdminPassword":{
            "type": "securestring",
            "metadata": {
                "description":"password for windows virtual machine"
            }
        },
        "sqlAdministratorLogin": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The SQL authentication admin user of the SQL Server, make a note of Username this will be used further"
            }
        },
        "sqlAdministratorLoginPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "The SQL authentication password of the admin user of the SQL Server, make a note of the Password this will be used further"
            }
        },
        "iotHubSkuName": {
            "type": "string",
            "defaultValue": "F1",
            "allowedValues": [
                "F1",
                "S1",
                "S2"
            ],
            "metadata": {
                "description": "One of the supported SKUs: F1, S1 or S2"
            }
        },
        "capacityUnits": {
            "type": "int",
            "minValue": 1,
            "defaultValue": 1,
            "metadata": {
                "description": "Number of desired IoT Hub units. Restricted to 1 unit for F1. Can be set up to maximum number allowed for subscription."
            }
        },
        "d2cMessageRetentionInDaysPeriod": {
            "type": "int",
            "minValue": 1,
            "maxValue": 7,
            "defaultValue": 1,
            "metadata": {
                "description": "Retention time in days for device-to-cloud messages."
            }
        },
        "d2cPartitionCount": {
            "type": "int",
            "minValue": 2,
            "defaultValue": 2,
            "allowedValues": [
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20,
                21,
                22,
                23,
                24,
                25,
                26,
                27,
                28,
                29,
                30,
                31,
                32
            ],
            "metadata": {
                "description": "Number of desired partitions for device-to-cloud event ingestion.Restricted to 1 unit for F1"
            }
        },
        "numberOfStreamingUnits": {
            "type": "int",
            "minValue": 1,
            "maxValue": 48,
            "defaultValue": 1,
            "allowedValues": [
              1,
              3,
              6,
              12,
              18,
              24,
              30,
              36,
              42,
              48
            ],
            "metadata": {
              "description": "Number of Streaming Units"
            }
          },
          "skuName": {
            "type": "string",
            "defaultValue": "B1",
            "allowedValues": [
                "D1",
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1",
                "P2",
                "P3",
                "P4"
            ],
            "metadata": {
                "description": "Describes plan's pricing tier and instance size. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/"
            }
        },
        "skuCapacity": {
            "type": "int",
            "defaultValue": 1,
            "minValue": 1,
            "metadata": {
                "description": "Describes plan's instance count"
            }
        }   
    },
    "variables": {
        "apiVersions": {
            "deploymentApiVersion": "2016-02-01",
            "sqlServerApiVersion": "2015-05-01-preview",
            "sqlDBApiVersion": "2014-04-01-preview",
            "workspaceApiVersion": "2016-04-01",
            "planApiVersion": "2016-05-01-preview",
            "webApiVersion": "2016-03-01",
            "iotHubApiversion": "2016-02-03",
            "saApiVersion": "2016-03-01",
            "networkApiVerion":"2017-08-01",
            "storageApiVersion":"2015-06-15",
            "computeApiVersion":"2016-04-30-preview"
        },
        "azureSQL": {
            "location": "[variables('location')]",
            "sqlAuthenticationLogin": "[parameters('sqlAdministratorLogin')]",
            "sqlAuthenticationPassword": "[parameters('sqlAdministratorLoginPassword')]",
            "collation": "SQL_Latin1_General_CP1_CI_AS",
            "databaseName1": "iotdb",
            "databaseName2": "webdb",
            "edition": "Basic",
            "requestedServiceObjectiveName": "Basic",
            "maxSizeBytes": "2147483648",
            "serverName": "[concat('sqlserver',variables('suffix'))]",
            "storageKeyType": "SharedAccessKey",
            "storageKey": "?",
            "tableName":"dbo.PowergridView",
            "storageUri1": "https://projectiot.blob.core.windows.net/iothub/iotdb.bacpac",
            "storageUri2": "https://projectiot.blob.core.windows.net/iothub/webdb.bacpac"
        },
        "webSiteSettings":{
            "location": "[variables('location')]",
            "hostingPlanName": "AppServPlan",
            "skuName": "[parameters('skuName')]",
            "skuCapacity": "[parameters('skuCapacity')]",
            "webSiteName1":"[concat('AssetDetails', variables('suffix'))]",
            "webSiteName2":"[concat('WeatherApi', variables('suffix'))]",
            "connectionString":"[concat('Server=tcp:',variables('azureSQL').serverName,'.database.windows.net,1433;Initial Catalog=',variables('azureSQL').databaseName1,';Persist Security Info=False;User ID=',variables('azureSQL').sqlAuthenticationLogin,';Password=',variables('azureSQL').sqlAuthenticationPassword,';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]",
            "AssetdetailsPackageURI":"https://projectiot.blob.core.windows.net/iothub/AssetDetails.zip",
            "WeatherApiPackageURI":"https://projectiot.blob.core.windows.net/iothub/SimulatedDevice_weatherapi.zip",
            "saStoken":"?",
            "jobCollectionName":"WeatherWebJob"
        },
        "iotHubSettings": {
            "location": "[variables('location')]",
            "iotHubName": "[concat('iot-hub', variables('suffix'))]",
            "skuName": "[parameters('iotHubSkuName')]",
            "capacityUnits": "[parameters('capacityUnits')]",
            "d2cMessageRetentionInDaysPeriod": "[parameters('d2cMessageRetentionInDaysPeriod')]",
            "d2cPartitionCount": "[parameters('d2cPartitionCount')]"
        },
        "streamAnalyticsSettings":{
            "location": "[variables('location')]",
            "streamAnalyticsJobName":"[concat('stream-analytics', variables('suffix'))]",
            "sku":"standard",
            "numberOfStreamingUnits":"[parameters('numberOfStreamingUnits')]"

        },
        "iotEdgeServer":{
            "location": "[variables('location')]",
            "virtualNetworkName":"iotedge-vnet",
            "addressPrefix":"10.0.0.0/16",
            "subnetName":"iotedge-subnet",
            "subnetPrefix":"10.0.0.0/24",
            "publicIpAddressName":"iotedage-pip",
            "publicIpAddressType":"Dynamic",
            "publicIpAddressSku":"Basic",
            "networkSecurityGroupName":"iotedge-nsg",
            "networkInterfaceName":"iotedge-nic",
            "dnsLabelPrefix":"[concat('iotedgeserver',variables('suffix'))]",
            "diagnosticsStorageAccountName":"[concat('strgaccnt',variables('suffix'))]",
            "diagnosticsStorageAccountType":"Standard_LRS",
            "virtualMachineName":"iotedgeserver",
            "adminUsername":"[parameters('iotEdgeAdminUserName')]",
            "adminPassword":"[parameters('iotEdgeadminPassword')]",
            "virtualMachineSize":"Standard_DS3_v2"


                },
        "location": "[resourceGroup().location]",
        "baseUrl": "https://raw.githubusercontent.com/sysgain/iot-emsre/staging/",
        "deploymentApiVersion": "2016-02-01",
        "suffix": "[substring(uniqueString(resourceGroup().id), 0, 5)]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "name": "IotEdgeServer",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/iot-edge.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "iotEdgeServer": {
                        "value": "[variables('iotEdgeServer')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "IotHub",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/iot-hub.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "iotHubSettings": {
                        "value": "[variables('iotHubSettings')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "SqlServer",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/sql-server.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "azureSQL": {
                        "value": "[variables('azureSQL')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "AppComponents",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "SqlServer"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/app-components.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "webSiteSettings": {
                        "value": "[variables('webSiteSettings')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "StreamAnalytics",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "IotHub",
                "AppComponents"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/stream-analytics.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "streamAnalyticsSettings": {
                        "value": "[variables('streamAnalyticsSettings')]"
                    },
                    "iotHubSettings": {
                        "value": "[variables('iotHubSettings')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    },
                    "azureSQL": {
                        "value": "[variables('azureSQL')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "azureSQLEndpoint": {
            "type": "string",
            "value": "[reference('SqlServer').outputs.azureSQLServerName.value]"
        },
        "azureSQLDB1Name": {
            "type": "string",
            "value": "[reference('SqlServer').outputs.iotDBName.value]"
        },
        "azureSQLDB2Name": {
            "type": "string",
            "value": "[reference('SqlServer').outputs.webDBName.value]"
        },
        "azureSQLUsername": {
            "type": "string",
            "value": "[parameters('sqlAdministratorLogin')]"
        },
        "windowsSQLUsername": {
            "type": "string",
            "value": "[parameters('sqlAdministratorLogin')]"
        }
    }
}